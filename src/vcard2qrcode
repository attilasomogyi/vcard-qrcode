#!/bin/sh
name_of_the_current_shell_script=$0
program_name=vcard2qrcode
number_of_program_arguments=$#
program_arguments=$@
short_options=i:,o:
long_options=input:,output:
check_number_of_program_arguments(){
    if [ $number_of_program_arguments -eq 0 ]; then
        exit_error
    fi
}
usage(){
    echo "Usage: $program_name [ -i | --input FILENAME ] [ -o | --output FILENAME ]" 1>&2
}
exit_error(){
    usage
    exit 1
}
check_file(){
    input_file=$1
    if [ -f $input_file ]; then
        if [ -s $input_file ]; then
            if [ ! -r $input_file ]; then
                echo "$input_file file is not readable." 1>&2
                exit_error
            fi
        else
            echo "$input_file file is empty." 1>&2
            exit_error
        fi
    else
        echo "$input_file file is not exists." 1>&2
        exit_error
    fi
}
check_vcard(){
    input_file=$1
    mime_type=$(file --brief --mime-type $input_file)
    if [ "$mime_type" != "text/vcard" ]; then
        echo "$input_file file is not vcard file." 1>&2
    fi
}
main(){
    check_number_of_program_arguments
    options=$(getopt --options $short_options --longoptions $long_options -- "$@")
    eval set -- ${options}
    while [ $# -gt 0 ]; do
        case "$1" in
            -i|--input)
                shift
                input_file=$1
                check_file $input_file
                check_vcard $input_file
                ;;
            -o|--output)
                shift
                output_file=$1
                output_file_extension=${output_file##*.}
                output_file=$(dirname "$output_file")/${output_file%.*}
                ;;
            --)
                break
                ;;
            *)
                exit_error
                ;;
        esac
        shift
    done
    if [ -z $input_file ]; then
        exit_error
    fi
    if [ -z $output_file ]; then
        output_file_extension=svg
        output_file=$(dirname "$input_file")/${input_file%.*}
    fi
    qrencode --read-from $input_file --type $output_file_extension --output $output_file.$output_file_extension
}
if [ "$name_of_the_current_shell_script" = "$_" ]; then
    main $program_arguments
fi
